var __extends = (this && this.__extends) || (function () {
    var extendStatics = Object.setPrototypeOf ||
        ({ __proto__: [] } instanceof Array && function (d, b) { d.__proto__ = b; }) ||
        function (d, b) { for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p]; };
    return function (d, b) {
        extendStatics(d, b);
        function __() { this.constructor = d; }
        d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
    };
})();
import { Directive, ElementRef, Host, Input } from '@angular/core';
import { Config, Tab, Tabs } from 'ionic-angular';
import { Observable } from 'rxjs/Observable';
import 'rxjs/add/observable/fromPromise';
import 'rxjs/add/operator/map';
import 'rxjs/add/operator/mergeMap';
import { CustomIconBase } from '../custom-icon-base';
import { HTMLElementClassUpdater } from '../util/HTMLElementClassUpdater';
/**
 * Directive for adding a custom icon to an ion-tab element. Use the input properties 'customIconSet' and
 * 'customIconName' to set the icon's set and name.
 *
 * Example usage:
 * @usage
 * ```html
 * <ion-tab customIconSet="mySet" customIconName="myIcon" ...></ion-tab>
 * ```
 *
 * @author Gerrit Erpenstein
 */
var TabCustomIcon = (function (_super) {
    __extends(TabCustomIcon, _super);
    function TabCustomIcon(_elementRef, _tab, _tabs, config) {
        var _this = _super.call(this, config) || this;
        _this._elementRef = _elementRef;
        _this._tab = _tab;
        _this._tabs = _tabs;
        /**
         * Icon set name
         */
        _this.iconSet = '';
        /**
         * Icon name
         */
        _this.iconName = '';
        // Observable from Promise that resolves when the icon is added to the DOM
        var iconAdded$ = Observable.fromPromise(new Promise(function (resolve) { return _this._iconAddedResolve = resolve; }));
        // Subscribe to tab change events and call _onTabSelected on change.
        _this._tabs.ionChange.asObservable()
            .flatMap(function (selectedTab) { return iconAdded$.map(function () { return selectedTab; }); })
            .subscribe(function (selectedTab) {
            _this._onTabSelected(selectedTab);
        });
        return _this;
    }
    /**
     * (Called after Angular projects external content into its view.)
     */
    TabCustomIcon.prototype.ngAfterContentInit = function () {
        var _this = this;
        setTimeout(function () {
            _this._addIcon();
        });
    };
    /**
     * Add icon element to it's corresponding tab.
     * @private
     */
    TabCustomIcon.prototype._addIcon = function () {
        var element = this._elementRef.nativeElement, tabsElement = this._tabs.getElementRef().nativeElement, index = -1, childNodes = tabsElement.childNodes, childNode, tabBarNode, tabNode;
        // Find tab bar node and index of tab item
        for (var i = 0, l = childNodes.length; i < l; i++) {
            childNode = childNodes[i];
            if (childNode.nodeType === 1) {
                if (childNode.classList.contains('tabbar')) {
                    // tab bar found!
                    tabBarNode = childNode;
                }
                else if (childNode.nodeName === 'ION-TAB') {
                    index++;
                    if (element === childNode) {
                        // target tab found!
                        break;
                    }
                }
            }
        }
        if (index === -1) {
            throw 'TabCustomIcon: Error finding tab index.';
        }
        // Find tab node in tab bar
        if (tabBarNode) {
            childNodes = tabBarNode.childNodes;
            var tabBarIndex = -1;
            for (var i = 0, l = childNodes.length; i < l; i++) {
                childNode = childNodes[i];
                if (childNode.nodeType === 1 && childNode.nodeName === 'A') {
                    tabBarIndex++;
                    if (index === tabBarIndex) {
                        // found target tab node
                        tabNode = childNode;
                        break;
                    }
                }
            }
        }
        else {
            throw 'TabCustomIcon: Error finding tab bar node "ion-tabbar"';
        }
        // add icon to tab
        if (tabNode) {
            // remove class 'has-title-only' from tab, add class 'has-icon'
            var tabCssClass = tabNode.className;
            tabCssClass = tabCssClass.replace(/(?:^|\s)has-title-only(?!\S)/, '');
            if (!/has-title/.test(tabCssClass))
                tabCssClass += ' icon-only';
            tabCssClass += ' has-icon';
            tabNode.className = tabCssClass;
            // create and add custom-icon element to tab
            this._iconElement = document.createElement('custom-icon');
            this.classUpdater = new HTMLElementClassUpdater(this._iconElement);
            tabNode.insertBefore(this._iconElement, tabNode.firstChild);
        }
        else {
            throw 'TabCustomIcon: Target tab not found.';
        }
        // add classes to custom icon element
        if (this.iconName && this.iconSet) {
            _super.prototype.updateIcon.call(this, this.iconName);
            _super.prototype.updateSet.call(this, this.iconSet);
        }
        this._iconElement.classList.add('tab-button-icon');
        // Resolve promise
        this._iconAddedResolve();
    };
    /**
     * Called on input parameter value changes.
     */
    TabCustomIcon.prototype.ngOnChanges = function (changes) {
        if (this._iconElement) {
            if (changes.hasOwnProperty('iconName')) {
                _super.prototype.updateIcon.call(this, this.iconName);
            }
            if (changes.hasOwnProperty('iconSet')) {
                _super.prototype.updateSet.call(this, this.iconSet);
            }
        }
    };
    /**
     * Called on selected tab change.
     * @param selectedTab The newly selected Tab
     * @private
     */
    TabCustomIcon.prototype._onTabSelected = function (selectedTab) {
        if (selectedTab === this._tab) {
            _super.prototype.updateActive.call(this, true);
        }
        else {
            _super.prototype.updateActive.call(this, false);
        }
    };
    /**
     * Called just before Angular destroys the directive/component.
     */
    TabCustomIcon.prototype.ngOnDestroy = function () {
        // remove icon element from DOM
        if (this._iconElement) {
            this._iconElement.classList.remove('tab-button-icon');
            _super.prototype.removeElementClasses.call(this);
            var parentNode = this._iconElement.parentNode;
            if (parentNode) {
                parentNode.removeChild(this._iconElement);
            }
        }
    };
    return TabCustomIcon;
}(CustomIconBase));
export { TabCustomIcon };
TabCustomIcon.decorators = [
    { type: Directive, args: [{
                selector: 'ion-tab[customIconSet],ion-tab[customIconName],'
            },] },
];
/** @nocollapse */
TabCustomIcon.ctorParameters = function () { return [
    { type: ElementRef, },
    { type: Tab, },
    { type: Tabs, decorators: [{ type: Host },] },
    { type: Config, },
]; };
TabCustomIcon.propDecorators = {
    'iconSet': [{ type: Input, args: ['customIconSet',] },],
    'iconName': [{ type: Input, args: ['customIconName',] },],
};
//# sourceMappingURL=tab-custom-icon.directive.js.map